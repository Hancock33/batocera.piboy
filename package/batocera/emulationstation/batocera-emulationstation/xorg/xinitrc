#!/bin/bash

mkdir -p "/var/log"
mkdir -p "/userdata/system/logs"

display_log="/userdata/system/logs/display.log"
nvidia_log="/var/log/nvidia.log"
amd_log="/userdata/system/logs/amd.log"

# hide mouse cursor
unclutter --noevents -b

# disable dpms to prevent screen from blanking
xset -dpms
xset s off

# uncomment to allow coredumps for ES
# ulimit -c unlimited

## [ Prime settings ]
# nvidia
if [ -f "/var/tmp/nvidia.prime" ]; then
    provider_count=$(xrandr --listproviders | grep 'Providers:' | awk '{print $4}')
    echo "Number of display providers = $provider_count" >> "$nvidia_log"
    # ensure we have 1 or more providers
    if [ "$provider_count" -ge 1 ]; then
        echo "Setting Nvidia Prime environment variables" >> "$nvidia_log"
        # find the Nvidia provider number
        provider_number=$(xrandr --listproviders | awk '/NVIDIA/ {print $2}' | tr -d ':')
        if [ -z "$provider_number" ]; then
            export __NV_PRIME_RENDER_OFFLOAD=1
        else
            export __NV_PRIME_RENDER_OFFLOAD=$provider_number
            echo "Nvidia Prime provider = $provider_number" >> "$nvidia_log"
        fi
        export __VK_LAYER_NV_optimus=NVIDIA_only
        export __GLX_VENDOR_LIBRARY_NAME=nvidia
    fi
fi

# amd
if [ -f "/var/tmp/amd.prime" ]; then
    echo "Setting AMD Prime environment variable" >> "$amd_log"
    amd_prime_value=$(<"/var/tmp/amd.prime")
    if [ -z "$amd_prime_value" ]; then
        export DRI_PRIME=1
    else
        export DRI_PRIME="$amd_prime_value"
        echo "AMD Prime environment variable set to $amd_prime_value" >> "$amd_log"
    fi
fi

openbox --config-file /etc/openbox/rc.xml --startup "emulationstation-standalone"
