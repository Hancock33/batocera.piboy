#!/bin/sh
BOOTCONF="/boot/batocera-boot.conf"

. /etc/profile.d/xdg.sh
. /etc/profile.d/dbus.sh

case "$1" in
	start)
		enabled="$(/usr/bin/batocera-settings-get system.es.atstartup)"
		if [ "$enabled" != "0" ]; then
		%BATOCERA_EMULATIONSTATION_CMD% %BATOCERA_EMULATIONSTATION_POSTFIX%
		fi
		;;

	stop)
		emulationstation-standalone --stop-rebooting
		killall openbox          2>/dev/null # for xorg
		killall sway             2>/dev/null # for sway (wayland)
		killall labwc            2>/dev/null # for labwc (wayland)
		killall touchegg         2>/dev/null

		# Kill emulationstation and then wait at least 20 seconds for it to exit, after 25s in total send SIGTERM
		killall emulationstation 2>/dev/null
		timeout -k 5 20 tail -q --pid=$(pidof emulationstation) -f /dev/null 2>/dev/null

		;;

	restart|reload)
		"$0" stop
		"$0" start
		;;

	*)
		echo "Usage: $0 {start|stop|restart}"
		exit 1
esac

exit $?
