#!/bin/bash

LOG="/userdata/system/logs/display.log"
LOCK_DIR="/var/run/batocera-switch-screen.lock"
STATUS_FILE="/var/run/batocera-switch-screen-checker-status"

_wait_for_emulationstation() {
    local timeout=30; local waited=0
    while [ "$(curl -s -o /dev/null -w '%{http_code}' http://localhost:1234/isIdle)" == "000" ]; do
        sleep 0.5; waited=$(echo "$waited + 0.5" | bc)
        if [ "$(echo "$waited > $timeout" | bc)" -eq 1 ]; then
            echo "Udev: Timed out waiting for EmulationStation web server." >> "$LOG"
            return 1
        fi
    done
    return 0
}

case "$1" in
    "--init")
        OUTPUT_LIST=$(batocera-resolution listOutputs)
        # Only log if outputs are found
        if [ -n "${OUTPUT_LIST}" ]; then
            LOGGABLE_OUTPUTS=$(echo "${OUTPUT_LIST}" | tr '\n' ' ')
            echo "Checker-Init: Storing current display list: [${LOGGABLE_OUTPUTS}]" >> "${LOG}"
        fi

        echo "${OUTPUT_LIST}" | sort > "${STATUS_FILE}"
        exit 0
        ;;
    *)
        if [ ! -f "${STATUS_FILE}" ]; then
            exit 0
        fi

        if ! mkdir "${LOCK_DIR}" 2>/dev/null; then exit 0; fi
        trap 'rm -rf "${LOCK_DIR}"' EXIT

        if ! _wait_for_emulationstation; then exit 1; fi

        # This script's only job is to trigger a restart.
        # The main standalone script will see the request file and handle all display logic.
        echo "Udev: Triggering display re-scan." >> "$LOG"

        OUTPUT_LIST=$(batocera-resolution listOutputs)
        if [ -n "${OUTPUT_LIST}" ]; then
            CURRENT_OUTPUTS=$(echo "${OUTPUT_LIST}" | tr '\n' ' ')
            echo "Udev: Outputs before restart trigger: [${CURRENT_OUTPUTS}]" >> "${LOG}"
        fi

        touch "/var/run/switch_screen_request"
        curl -s http://localhost:1234/quit
        ;;
esac
