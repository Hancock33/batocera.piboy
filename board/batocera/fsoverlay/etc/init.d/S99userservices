#!/bin/bash

# custom.sh : deprecated
if test -e "/userdata/system/custom.sh"; then
    #bash interpreter executes scripts without x-flag e.g. for vFAT
    bash /userdata/system/custom.sh $1 &
fi

enabled_services="$(/usr/bin/batocera-settings-get system.services)"

if test -n "${enabled_services}"
then
    for SERVICE in ${enabled_services}
    do
	export __SERVICE__${SERVICE}=1
    done
fi

# user services
find -L /userdata/system/services -type f |
    while read SERVICE
    do
    BASE_SERVICE=${SERVICE##*/}
    if echo "${BASE_SERVICE,,}" | grep -q -E ^[a-z].[a-z0-9_]*$; then
        SRVVAR=__SERVICE__${BASE_SERVICE}
        if test "${!SRVVAR}" = 1; then
    	    bash "${SERVICE}" "${1}" &
            echo "User Service: ${BASE_SERVICE} - service is enabled - filename [ok]"
        else
            echo "User Service: ${BASE_SERVICE} - service is disabled - filename [ok]"            
        fi
    else
        string_new=${BASE_SERVICE//[^A-Za-z0-9_]/}
        string_new=$(echo "$string_new" | sed 's/[[:digit:]]*//')
        echo "User Service: $BASE_SERVICE needs rename to $string_new - filename [ko]"
    fi
    done

# system user services
find -L /usr/share/batocera/services -type f |
    while read SERVICE
    do
    BASE_SERVICE=${SERVICE##*/}
    SRVVAR=__SERVICE__${BASE_SERVICE}
    if test "${!SRVVAR}" = 1; then
        bash "${SERVICE}" "${1}" &
        echo "System Service: ${BASE_SERVICE} - service is enabled - filename [ok]"
    else
        echo "System Service: ${BASE_SERVICE} - service is disabled - filename [ok]"
    fi
    done

# wait scripts to finish on stop condition, shutdown can happen
test "${1}" = "stop" && wait
